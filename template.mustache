<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name=viewport content="width=device-width, initial-scale=1">
<title>Headlines | Baleen</title>
<style>
body, div {
	margin: 0;
	border: 0;
	padding: 0;

	font-family: Helvetica, sans-serif;
}

.content {
	max-width:40em;
	margin: auto;
}

.tweet {
	padding-top: 0.75em;
	border-bottom: 1px #eee solid;
	padding-bottom:0.25em;
	overflow:hidden;
}

a {
	color: #333;
}

a:visited {
	color: #999;
}

.tweet-profile-image {
	float:left;
}

.tweet-text-block {
	margin-left:60px;
	margin-right: 10px;
}

.tweet-screen-name {
	font-style: italic;
}

.tweet-timestamp {
	color:gray;
	font-size: 0.8em;
	font-style:italic;
	display:inline-block;
}

.media-image {
	padding-top:0.25em;
}

.more-tweets {
	/*margin-left:15px;*/
	display: none;
}

.story-active {
	background-color: #FAFAF0;
}

.story-active .more-tweets{
	display: block;
}

.meta {
	color:gray;
	text-align: right;
}

</style>
</head>
<body>
	<div class="content">
	{{#top}}
	<div class="story">
		<div class="tweet">
			<div  class="tweet-profile-image">
				<a href="https://twitter.com/{{top_tweet.screen_name}}/statuses/{{top_tweet.tweet_id}}">
					<img src="{{top_tweet.profile_image_url}}" width=48 height=48>
				</a>
			</div>
			<div class="tweet-text-block">
				<span class="tweet-screen-name">@{{top_tweet.screen_name}}</span>
				{{{top_tweet.expanded_text}}}
				<span class="relativize tweet-timestamp" data-timestamp="{{top_tweet.created_at}}">{{top_tweet.created_at}}</span>
				{{#top_tweet.media_url}}
				<img src="{{top_tweet.media_url}}" width="100%" class="media-image">
				{{/top_tweet.media_url}}
			</div>
		</div>
		<div class="more-tweets">
		{{#more_tweets}}
			<div class="tweet">
				<div  class="tweet-profile-image">
					<a href="https://twitter.com/{{screen_name}}/statuses/{{tweet_id}}">
						<img data-src="{{profile_image_url}}" width=48 height=48>
					</a>
				</div>
				<div class="tweet-text-block">
					<span class="tweet-screen-name">@{{screen_name}}</span>
					{{{expanded_text}}}
					<span class="relativize tweet-timestamp" data-timestamp="{{created_at}}">{{created_at}}</span>
					{{#media_url}}
					<img data-src="{{media_url}}" width="100%" class="media-image">
					{{/media_url}}
				</div>
			</div>
		{{/more_tweets}}
		</div>
	</div>
	{{/top}}
	<div class="meta">Last updated <span id="last-updated" class="relativize" data-timestamp="{{meta.last_updated}}">at {{meta.last_updated}}</span></div>
	<div class="meta">Window is {{meta.window_minutes}} minutes long.</div>
	</div>
<script>
function number_string(n,unit) {
	n = Math.round(n);
	var numstr;
	if (n < 10) {
		numstr = ["zero","one","two","three","four","five","six","seven","eight","nine"][n];
	} else {
		numstr = n.toString()
	}
	if (n>1) {
		unit += "s";
	}
	return numstr + " " + unit + " ago"
}

function seconds_to_phrase(s) {
	if (s>60*60) {
		var hours_ago = Math.round(s/(60*60));
		return number_string(hours_ago,"hour");
	} else if (s > 60) {
		var minutes_ago = Math.round(s/60);
		return number_string(minutes_ago,"minute");
	} else if (s > 0) {
		return number_string(s,"second");
	} else {
		return "in the mysterious future!";
	}
};

function relativize(elem) {
	var now_date = new Date();
	var updated_date = new Date(elem.dataset.timestamp);
	var seconds_old = (now_date-updated_date)/1000;

	elem.innerHTML = seconds_to_phrase(seconds_old);
};

Array.prototype.forEach.call(document.getElementsByClassName("relativize"), relativize);

function storyScroll(story) {
	var elem = story.getElementsByClassName("tweet")[0];
	if (elem.scrollIntoViewIfNeeded) {
		elem.scrollIntoViewIfNeeded()
	} else {
		elem.scrollIntoView(true)
	}
}

function toggleSubtweets(e) {
	var active_story = document.getElementsByClassName("story-active")[0];
	if (active_story) {
		active_story.classList.remove("story-active");
	}
	if (active_story != this) {
		this.classList.add("story-active");
		storyScroll(this);
	} else {
		storyScroll(active_story);
	}
	Array.prototype.forEach.call(this.getElementsByTagName("img"),
		function(i) {
			if (!i.getAttribute("src")) {
				i.setAttribute("src",i.dataset.src);
			}
		});
}

Array.prototype.forEach.call(document.getElementsByClassName("story"), 
	function(e){
		e.addEventListener("click",toggleSubtweets);
		e.addEventListener("touch",toggleSubtweets);
	});

function stopBubbling(e) {
	e.stopPropagation();
}

Array.prototype.forEach.call(document.getElementsByTagName("a"), 
	function(e){
		e.addEventListener("click",stopBubbling);
		e.addEventListener("touch",stopBubbling);
	});

</script>
</body>
</html>